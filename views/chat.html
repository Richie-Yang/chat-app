<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Chat</title>
    <link rel="stylesheet" href="/public/stylesheets/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.3/moment.min.js"></script>
  </head>

  <body>
    <ul class="tab-container nav nav-pills">
      <li class="nav-item">
        <a class="nav-link" href="/user-list">User-List</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="logout">Logout</a>
      </li>
    </ul>

    <ul class="chat-container">
      <li id="messages" class="chat"></li>
    </ul>

    <form id="form" action="">
      <input id="input" autocomplete="off" /><button>Send</button>
      <button id="toggle-btn">Disconnect</button>
    </form>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      const token = sessionStorage.getItem('token');
      const chatId = sessionStorage.getItem('chatId');
      const fromId = sessionStorage.getItem('fromId');
      const toId = sessionStorage.getItem('toId');

      if (!token) window.location.href = './login';
      if (!chatId || !fromId || !toId) window.location.href = './user-list';
      const socket = io({
        extraHeaders: {
          authorization: `Bearer ${token}`,
        },
      });

      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const messages = document.getElementById('messages');
      const logout = document.getElementById('logout');
      const toggleButton = document.getElementById('toggle-btn');

      function parseMessage(messageData, fromId) {
        const { content, from, createdAt } = messageData;
        const datetime = moment(createdAt * 1000).format('YYYY-MM-DD HH:mm:ss');
        const source = fromId === from.id ? 'right' : 'left';
        const talker = source === 'right' ? 'You' : from.name;
        return {
          source,
          message: `${talker}:\n${content}`,
          at: datetime,
        };
      }

      function appendMessage(msg) {
        const { source, message, at } = msg;
        const item = document.createElement('li');
        item.classList.add('message', source);

        const image = document.createElement('img');
        image.classList.add('logo');
        image.setAttribute('src', './public/images/default_avatar.png');

        const text = document.createElement('p');
        text.textContent = message;
        const time = document.createElement('span');
        time.textContent = at;

        const elements = [image, text, time];
        for (const element of elements) item.appendChild(element);
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
      }

      fetch(`/api/chat/${chatId}/messages?filter={"limit":10}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
      })
        .then((response) => response.json())
        .then((parsedRes) => {
          console.log('parsedRes:', parsedRes);

          parsedRes.data.forEach((messageData) => {
            const msg = parseMessage(messageData, fromId);
            appendMessage(msg);
          });
        })
        .catch((err) => {
          console.log(err);
        });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log(input.value);
        if (!input.value) return;

        socket.emit('chat message', {
          fromId,
          toId,
          content: input.value,
          chatId,
        });
        input.value = '';
      });

      logout.addEventListener('click', (e) => {
        e.preventDefault();
        return fetch('/api/user/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: token,
          },
        })
          .then((response) => response.json())
          .then((parsedRes) => {
            console.log('parsedRes:', parsedRes);
            sessionStorage.removeItem('token');
            window.location.href = './login';
          })
          .catch((err) => {
            console.log(err);
          });
      });

      toggleButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (socket.connected) {
          toggleButton.innerText = 'Connect';
          socket.disconnect();
        } else {
          toggleButton.innerText = 'Disconnect';
          socket.connect();
        }
      });

      socket.on(chatId, (messageData) => {
        const msg = parseMessage(messageData, fromId);
        appendMessage(msg);
      });
    </script>
  </body>
</html>
